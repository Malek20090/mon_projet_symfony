{% extends 'base.html.twig' %}

{% block title %}Admin - Objectifs{% endblock %}

{% block body %}

<h1>Admin - Tous les objectifs</h1>

<a href="{{ path('admin_dashboard') }}">‚¨Ö Retour Dashboard</a>

<br><br>

{# ============================= #}
{#        STATISTIQUES           #}
{# ============================= #}

{% set completed = 0 %}
{% set inProgress = 0 %}

{% for obj in objectifs %}
    {% if obj.isCompleted %}
        {% set completed = completed + 1 %}
    {% else %}
        {% set inProgress = inProgress + 1 %}
    {% endif %}
{% endfor %}

<h2>üìä Statistiques globales</h2>

<div style="width: 300px; margin: auto;">
    <canvas id="objectifChart"></canvas>
</div>

<br><br>

{# ============================= #}
{#            TABLEAU            #}
{# ============================= #}

<table border="1" cellpadding="10" width="100%">
    <thead>
        <tr>
            <th>Nom</th>
            <th>Montant actuel</th>
            <th>Multiplicateur</th>
            <th>Montant cible</th>
            <th>Statut</th>
            <th>Action</th>
        </tr>
    </thead>
    <tbody>
        {% for obj in objectifs %}
            {% set currentAmount = calculator.calculateCurrentAmountForObjectif(obj) %}
            <tr>
                <td>{{ obj.name }}</td>

                <td>{{ currentAmount|number_format(2) }}</td>
                <td>x{{ obj.targetMultiplier }}</td>
                <td>{{ obj.targetAmount|number_format(2) }}</td>

                <td>
                    {% if obj.isCompleted %}
                        <span style="color:green; font-weight:bold;">‚úî Atteint</span>
                    {% else %}
                        <span style="color:orange; font-weight:bold;">‚è≥ En cours</span>
                    {% endif %}
                </td>

                <td>
                    <form method="post"
                          action="{{ path('admin_objectif_delete', {id: obj.id}) }}"
                          onsubmit="return confirm('Confirmer la suppression ?');">

                        <input type="hidden"
                               name="_token"
                               value="{{ csrf_token('delete_objectif_' ~ obj.id) }}">

                        <button type="submit"
                                style="color:white; background:red; border:none; padding:5px 10px; cursor:pointer;">
                            Supprimer
                        </button>
                    </form>
                </td>
            </tr>
        {% else %}
            <tr>
                <td colspan="6">Aucun objectif</td>
            </tr>
        {% endfor %}
    </tbody>
</table>

{# ============================= #}
{#        SCRIPT CHART.JS        #}
{# ============================= #}

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
    const ctx = document.getElementById('objectifChart');

    new Chart(ctx, {
        type: 'pie',
        data: {
            labels: ['Atteints', 'En cours'],
            datasets: [{
                data: [{{ completed }}, {{ inProgress }}],
                backgroundColor: [
                    'rgba(75, 192, 75, 0.8)',
                    'rgba(255, 159, 64, 0.8)'
                ],
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: {
                    position: 'bottom'
                }
            }
        }
    });
</script>

{% endblock %}
