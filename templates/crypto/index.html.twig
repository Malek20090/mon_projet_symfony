{% extends 'base_pages.html.twig' %}

{% block title %}Cryptos{% endblock %}

{% block body_class %}savings-page{% endblock %}

{% block stylesheets %}
  <link rel="stylesheet" href="{{ asset('css/decides-savings.css') }}?v=1000">
{% endblock %}

{% block body %}
<section class="hero">
  <div class="wrap container text-center">
    <h1>Cryptos</h1>
    <p>Suivez les prix, vos investissements et vos performances.</p>
  </div>
</section>

<section class="savings-zone">
  <div class="container">
    <div class="section-title">
      <div class="kicker">DECIDE$ MODULE</div>
      <h2>Liste des cryptomonnaies</h2>
      <p>Tableaux clairs, actions visibles, et recherche rapide.</p>
    </div>

    <div class="card">
      <div class="table-wrap">
        <table class="table" cellpadding="10">
          <thead>
            <tr>
              <th>Nom</th>
              <th>Symbole</th>
              <th>Prix actuel (USD)</th>
            </tr>
          </thead>
          <tbody>
            {% for crypto in cryptos %}
              <tr>
                <td>{{ crypto.name }}</td>
                <td>{{ crypto.symbol }}</td>
                <td>{{ crypto.currentprice }}</td>
              </tr>
            {% else %}
              <tr>
                <td colspan="3">Aucune crypto trouvée</td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>

      <div class="actions-row">
        <form method="post" action="{{ path('crypto_update_prices') }}">
          <button type="submit" class="primary-btn">Mettre à jour les prix</button>
        </form>

        <a href="{{ path('investissement_new') }}">
          <button type="button" class="primary-btn">Faire un investissement</button>
        </a>
      </div>
    </div>

    <div class="card">
      <div class="section-title" style="margin-bottom: 12px;">
        <h3>Mes investissements</h3>
      </div>

      <form method="get" action="{{ path('crypto_index') }}" class="search-row">
        <input
          type="text"
          name="search"
          placeholder="Nom de la crypto (ex: Bitcoin)"
          value="{{ currentSearch }}"
        >

        {% if currentSort %}
          <input type="hidden" name="sort" value="{{ currentSort }}">
        {% endif %}

        <button type="submit" class="primary-btn">Rechercher</button>
      </form>

      <div class="table-wrap" style="margin-top: 16px;">
        <table class="table" cellpadding="10">
          <thead>
            <tr>
              <th>Crypto</th>
              <th>Montant investi (USD)</th>
              <th>Prix d'achat</th>
              <th>Quantité</th>
              <th>Gain / Perte (USD)</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            {% for investissement in investissements %}
              {% set gain = calculator.calculateGain(investissement) %}
              <tr>
                <td>{{ investissement.crypto.name }}</td>
                <td>{{ investissement.amountInvested }}</td>
                <td>{{ investissement.buyPrice }}</td>
                <td>{{ investissement.quantity }}</td>
                <td style="color: {{ gain >= 0 ? 'green' : 'red' }}; font-weight: bold;">
                  {{ gain|number_format(2) }}
                </td>
                <td>
                  <a href="{{ path('investissement_adjust', { id: investissement.id }) }}">
                    <button type="button" class="ghost-btn">Ajuster</button>
                  </a>

                  <form
                    method="post"
                    action="{{ path('investissement_delete', { id: investissement.id }) }}"
                    onsubmit="return confirm('Supprimer cet investissement ?');"
                    style="display:inline;"
                  >
                    <button type="submit" class="danger-btn">Supprimer</button>
                  </form>
                </td>
              </tr>
            {% else %}
              <tr>
                <td colspan="6">Aucun investissement</td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>

      <div class="actions-row" style="margin-top: 12px;">
        <span style="font-weight: 700;">Trier</span>
        <a class="chip" href="{{ path('crypto_index', { sort: 'amount_desc' }) }}">Montant ⬇</a>
        <a class="chip" href="{{ path('crypto_index', { sort: 'amount_asc' }) }}">Montant ⬆</a>
        <a class="chip" href="{{ path('crypto_index', { sort: 'gain_desc' }) }}">Gain ⬇</a>
        <a class="chip" href="{{ path('crypto_index', { sort: 'gain_asc' }) }}">Perte ⬆</a>
      </div>
    </div>

    <div class="page-actions">
      <a href="{{ path('objectif_index') }}">← Objectif</a>
    </div>
  </div>
</section>
{% endblock %}
