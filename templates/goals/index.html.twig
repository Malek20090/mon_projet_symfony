{% extends 'base.html.twig' %}
{% block title %}Goals | Backoffice{% endblock %}

{% block body %}

{# -------- SAFE DEFAULTS -------- #}
{% set dash = '-' %}
{% set goals = goals|default([]) %}
{% set savingAccounts = savingAccounts|default([]) %}
{% set stats = stats|default({ total: goals|length, active: 0, overdue: 0, completed: 0 }) %}
{% set saStats = saStats|default({ total: savingAccounts|length, sum_sold: 0, avg_rate: 0 }) %}

<style>
  :root{
    --bg:#f6f8fb;
    --card:#ffffff;
    --soft:#f1f4f8;
    --text:#0f1a2b;
    --muted:#6f7f8c;
    --border:rgba(0,0,0,.08);
    --blue:#2f6fed;
    --shadow: 0 18px 40px rgba(0,0,0,.08);
  }
  body{ background:var(--bg); color:var(--text); }
  .page-wrap{ padding:28px 28px 40px; max-width:1200px; margin:0 auto; }
  h1{ margin:0 0 6px; font-size:36px; letter-spacing:-0.6px; }
  .sub{ color:var(--muted); margin-bottom:22px; }

  .card{
    background:var(--card);
    border-radius:24px;
    box-shadow:var(--shadow);
    border:1px solid var(--border);
    padding:18px;
  }

  .filterbar{
    display:grid;
    grid-template-columns: 1.2fr 0.9fr 0.9fr 0.9fr 0.9fr auto;
    gap:14px;
    align-items:center;
    padding:18px;
    border-radius:22px;
    background:linear-gradient(180deg, rgba(255,255,255,.95), rgba(255,255,255,.85));
    border:1px solid var(--border);
  }

  .inp, .sel{
    width:100%;
    padding:14px 14px;
    border-radius:14px;
    border:1px solid var(--border);
    background:var(--soft);
    outline:none;
    font-size:14px;
  }

  .btn{
    border:0;
    border-radius:14px;
    padding:14px 18px;
    font-weight:800;
    cursor:pointer;
    font-size:14px;
    white-space:nowrap;
  }
  .btn-primary{ background:var(--blue); color:#fff; min-width:150px; }
  .btn-ghost{
    background:transparent;
    border:1px solid var(--border);
    color:var(--text);
    font-weight:800;
  }

  .toprow{
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:14px;
    margin-top:16px;
    margin-bottom:10px;
    flex-wrap:wrap;
  }

  .pill{
    display:inline-flex;
    align-items:center;
    gap:8px;
    padding:8px 12px;
    border-radius:999px;
    background:var(--soft);
    border:1px solid var(--border);
    font-weight:800;
    font-size:12px;
    color:var(--muted);
  }

  table{ width:100%; border-collapse:collapse; margin-top:12px; overflow:hidden; border-radius:18px; }
  th, td{ padding:14px 12px; border-bottom:1px solid var(--border); font-size:14px; vertical-align:middle; }
  th{ text-align:left; color:var(--muted); font-weight:900; background:#fff; }
  tr:hover td{ background:rgba(47,111,237,.05); }

  .badge{ padding:8px 12px; border-radius:999px; font-weight:900; font-size:12px; display:inline-block; }
  .b-active{ background:rgba(47,111,237,.12); color:#1f56c7; }
  .b-overdue{ background:rgba(255,0,0,.10); color:#c01212; }
  .b-completed{ background:rgba(0,200,120,.12); color:#0c7b4f; }

  .progress{ height:10px; border-radius:999px; background:rgba(0,0,0,.06); overflow:hidden; border:1px solid var(--border); }
  .progress > div{ height:100%; background:var(--blue); width:0; }

  .money{ font-weight:950; }
  .muted{ color:var(--muted); }
  .exports{ display:flex; gap:10px; flex-wrap:wrap; }
  .linkbtn{ text-decoration:none; display:inline-flex; align-items:center; justify-content:center; }

  .section-title{ margin:26px 0 8px; font-size:20px; font-weight:950; }

  @media (max-width: 900px){
    .filterbar{ grid-template-columns: 1fr 1fr; }
    .btn-primary{ min-width:unset; width:100%; }
  }
</style>

<div class="page-wrap">

  <h1>Goals</h1>
  <div class="sub">Manage user goals and progress</div>

  {# ===========================
     GOALS FILTER BAR (g_*)
     =========================== #}
  <form method="get" action="{{ path('admin_goals_admin_goals_index') }}" class="filterbar">
    <input class="inp" name="g_q" value="{{ app.request.get('g_q') }}" placeholder="User name / email">

    <select class="sel" name="g_status">
      {% set gs = app.request.get('g_status') %}
      <option value="" {{ gs == '' ? 'selected' : '' }}>All status</option>
      <option value="active" {{ gs == 'active' ? 'selected' : '' }}>Active</option>
      <option value="completed" {{ gs == 'completed' ? 'selected' : '' }}>Completed</option>
      <option value="overdue" {{ gs == 'overdue' ? 'selected' : '' }}>Overdue</option>
    </select>

    <select class="sel" name="g_priority">
      {% set gp = app.request.get('g_priority') %}
      <option value="" {{ gp == '' ? 'selected' : '' }}>All priorities</option>
      {% for p in 1..5 %}
        <option value="{{ p }}" {{ gp == p ? 'selected' : '' }}>P{{ p }}</option>
      {% endfor %}
    </select>

    <input class="inp" type="date" name="g_from" value="{{ app.request.get('g_from') }}">
    <input class="inp" type="date" name="g_to" value="{{ app.request.get('g_to') }}">

    <button type="submit" class="btn btn-primary">Filter</button>
  </form>

  {# ===========================
     GOALS TABLE + EXPORTS
     =========================== #}
  <div class="card" style="margin-top:18px;">

    <div class="toprow">
      <div style="display:flex; gap:10px; flex-wrap:wrap;">
        <span class="pill">Total: <b>{{ stats.total|default(0) }}</b></span>
        <span class="pill">Active: <b>{{ stats.active|default(0) }}</b></span>
        <span class="pill">Overdue: <b>{{ stats.overdue|default(0) }}</b></span>
        <span class="pill">Completed: <b>{{ stats.completed|default(0) }}</b></span>
      </div>

      <div class="exports">
        <a class="btn btn-ghost linkbtn"
           href="{{ path('admin_goals_admin_goals_export_goals_csv', app.request.query.all) }}">
          Export CSV
        </a>

        <a class="btn btn-ghost linkbtn"
           href="{{ path('admin_goals_admin_goals_export_goals_pdf', app.request.query.all) }}">
          Export PDF
        </a>
      </div>
    </div>

    <table>
      <thead>
        <tr>
          <th style="width:70px;">#</th>
          <th>User</th>
          <th>Goal</th>
          <th>Target</th>
          <th>Current</th>
          <th style="width:210px;">Progress</th>
          <th>Deadline</th>
          <th>Priority</th>
          <th>Status</th>
        </tr>
      </thead>

      <tbody>
      {% for r in goals %}
        {% set pct = r.progress|default(0) %}
        <tr>
          <td class="muted">{{ r.id|default(dash) }}</td>

          <td>
            <div style="font-weight:950;">{{ r.u_label|default(dash) }}</div>
            <div class="muted" style="font-size:12px;">SA #{{ r.saving_account_id|default(dash) }}</div>
          </td>

          <td style="font-weight:900;">üéØ {{ r.nom|default(dash) }}</td>

          <td class="money">{{ r.montant_cible|default(0) }} DT</td>
          <td class="money">{{ r.montant_actuel|default(0) }} DT</td>

          <td>
            <div class="progress"><div style="width: {{ pct }}%"></div></div>
            <div class="muted" style="font-size:12px; margin-top:6px;">{{ pct|round }}%</div>
          </td>

          <td>
            {% if r.date_limite is not empty %}
              {{ r.date_limite is iterable ? r.date_limite : r.date_limite }}
            {% else %}
              {{ dash }}
            {% endif %}
          </td>

          <td><span class="pill">üè∑Ô∏è P{{ r.priorite|default(dash) }}</span></td>

          <td>
            {% set stt = r.status|default('active') %}
            {% if stt == 'completed' %}
              <span class="badge b-completed">COMPLETED</span>
            {% elseif stt == 'overdue' %}
              <span class="badge b-overdue">OVERDUE</span>
            {% else %}
              <span class="badge b-active">ACTIVE</span>
            {% endif %}
          </td>
        </tr>
      {% else %}
        <tr><td colspan="9" class="muted">No goals found for current filters.</td></tr>
      {% endfor %}
      </tbody>
    </table>
  </div>

  {# ===========================
     SAVING ACCOUNTS SECTION
     =========================== #}
  <div class="section-title">Saving Accounts</div>
  <div class="sub" style="margin-top:0;">Manage user saving accounts (balance & rate)</div>

  <form method="get" action="{{ path('admin_goals_admin_goals_index') }}" class="filterbar">
    <input class="inp" name="sa_q" value="{{ app.request.get('sa_q') }}" placeholder="User name / email">
    <input class="inp" name="sa_min" value="{{ app.request.get('sa_min') }}" placeholder="Min balance">
    <input class="inp" name="sa_max" value="{{ app.request.get('sa_max') }}" placeholder="Max balance">
    <input class="inp" type="date" name="sa_from" value="{{ app.request.get('sa_from') }}">
    <input class="inp" type="date" name="sa_to" value="{{ app.request.get('sa_to') }}">
    <button type="submit" class="btn btn-primary">Filter</button>
  </form>

  <div class="card" style="margin-top:18px;">

    <div class="toprow">
      <div style="display:flex; gap:10px; flex-wrap:wrap;">
        <span class="pill">Total: <b>{{ saStats.total|default(0) }}</b></span>
        <span class="pill">Sum balance: <b>{{ saStats.sum_sold|default(0) }}</b></span>
        <span class="pill">Avg rate: <b>{{ saStats.avg_rate|default(0)|round(2) }}</b>%</span>
      </div>

      <div class="exports">
        <a class="btn btn-ghost linkbtn"
           href="{{ path('admin_goals_admin_goals_export_saving_csv', app.request.query.all) }}">
          Export CSV
        </a>

        <a class="btn btn-ghost linkbtn"
           href="{{ path('admin_goals_admin_goals_export_saving_pdf', app.request.query.all) }}">
          Export PDF
        </a>
      </div>
    </div>

    <table>
      <thead>
        <tr>
          <th style="width:70px;">#</th>
          <th>User</th>
          <th>Balance</th>
          <th>Interest rate</th>
          <th>Created</th>
        </tr>
      </thead>

      <tbody>
      {% for sa in savingAccounts %}
        <tr>
          <td class="muted">{{ sa.id|default(dash) }}</td>
          <td style="font-weight:950;">{{ sa.u_label|default(dash) }}</td>
          <td class="money">{{ sa.sold|default(0) }} DT</td>
          <td>{{ sa.taux_interet|default(0) }}%</td>
          <td>
            {% if sa.date_creation is not empty %}
              {{ sa.date_creation|date("Y-m-d") }}
            {% else %}
              {{ dash }}
            {% endif %}
          </td>
        </tr>
      {% else %}
        <tr><td colspan="5" class="muted">No saving accounts found for current filters.</td></tr>
      {% endfor %}
      </tbody>
    </table>
  </div>

</div>
{% endblock %}
